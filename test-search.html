<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Search - Nebraska Treatment Connect</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .test-controls { 
            background: #f8f9fa; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            border: 2px solid #007bff;
        }
        .test-log { 
            background: #f1f3f4; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-family: monospace; 
            max-height: 300px; 
            overflow-y: auto;
        }
        .test-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .search-container { 
            border: 2px solid #ffc107; 
            background: #fff3cd;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1><a href="index.html">Nebraska Treatment Connect - TEST MODE</a></h1>
            </div>
        </div>
    </header>

    <main>
        <section id="search-section" class="container">
            <div class="test-controls">
                <h3>🧪 Testing Geneva 68361 Search Fix</h3>
                <button class="test-button" onclick="runTest()">Run Test Search</button>
                <button class="test-button" onclick="clearLog()">Clear Log</button>
                <div id="test-log" class="test-log">Ready to test...</div>
            </div>

            <h2>Find Residential Treatment, Halfway Houses, and Outpatient Services in Nebraska</h2>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Search by name, city, or ZIP code..." value="68361">
                <button id="search-btn"><i class="fas fa-search"></i></button>
                <button id="use-location-btn" title="Use my current location"><i class="fas fa-crosshairs"></i></button>
            </div>
            <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 10px;">
                <i class="fas fa-map-marker-alt"></i> Search for your city or <i class="fas fa-crosshairs"></i> use your current location
            </p>
            <div class="filters-container">
                <div class="filter-group">
                    <label for="search-radius">Search Radius</label>
                    <select id="search-radius">
                        <option value="25">25 miles</option>
                        <option value="50">50 miles</option>
                        <option value="75" selected>75 miles</option>
                        <option value="100">100 miles</option>
                        <option value="150">150 miles</option>
                        <option value="999">All distances</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="age-group">Age Group</label>
                    <select id="age-group">
                        <option value="">All</option>
                        <option value="Adult">Adult</option>
                        <option value="Youth">Youth</option>
                        <option value="Both">Both</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="gender-served">Gender Served</label>
                    <select id="gender-served">
                        <option value="">All</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Co-ed">Co-ed</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="treatment-type">Treatment Type</label>
                    <select id="treatment-type">
                        <option value="">All</option>
                        <option value="Substance Abuse">Substance Abuse</option>
                        <option value="Mental Health">Mental Health</option>
                        <option value="Both">Both</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="facility-type">Facility Type</label>
                    <select id="facility-type">
                        <option value="">All</option>
                        <option value="Residential">Residential</option>
                        <option value="Halfway House">Halfway House</option>
                        <option value="Outpatient">Outpatient</option>
                    </select>
                </div>
            </div>

            <div class="view-toggle">
                <button id="list-view-btn" class="view-btn active">
                    <i class="fas fa-list"></i> List View
                </button>
                <button id="map-view-btn" class="view-btn">
                    <i class="fas fa-map"></i> Map View
                </button>
            </div>

            <div class="results-header">
                <div class="results-count">
                    <span id="total-results">0</span> facilities found
                </div>
            </div>

            <div id="facilities-list" class="facilities-grid">
                <p class="no-results">Loading facilities...</p>
            </div>

            <div id="map-container" style="display: none;">
                <div id="map" style="height: 600px; width: 100%;"></div>
            </div>
        </section>
    </main>

    <script src="scripts.js"></script>
    <script>
        // Test logging function
        function testLog(message) {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[TEST] ${message}`);
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = 'Log cleared...';
        }

        function runTest() {
            testLog('🚀 Starting test search for Geneva 68361...');
            testLog('📋 Search term: "68361"');
            testLog('📏 Radius: 75 miles');
            testLog('🔍 Clicking search button...');
            
            // Trigger the search
            document.getElementById('search-btn').click();
            
            // Check results after a delay
            setTimeout(() => {
                const totalResults = document.getElementById('total-results').textContent;
                const facilitiesList = document.getElementById('facilities-list');
                const facilityCards = facilitiesList.querySelectorAll('.facility-card');
                
                testLog(`📊 Results found: ${totalResults}`);
                testLog(`🏥 Facility cards rendered: ${facilityCards.length}`);
                
                if (parseInt(totalResults) > 0) {
                    testLog('✅ SUCCESS: Facilities found within radius!');
                    // Log first few facilities
                    for (let i = 0; i < Math.min(3, facilityCards.length); i++) {
                        const facilityName = facilityCards[i].querySelector('h3').textContent;
                        const distanceElement = facilityCards[i].querySelector('.distance');
                        const distance = distanceElement ? distanceElement.textContent : 'Distance not shown';
                        testLog(`   ${i+1}. ${facilityName} - ${distance}`);
                    }
                } else {
                    testLog('❌ FAILURE: No facilities found - search may still be broken');
                }
            }, 3000); // Wait 3 seconds for API calls to complete
        }

        // Override the original geocodeAndFilterByDistance function to add logging
        const originalGeocodeAndFilterByDistance = window.geocodeAndFilterByDistance;
        window.geocodeAndFilterByDistance = async function(locationTerm, facilities) {
            testLog(`🌐 Geocoding started for: "${locationTerm}"`);
            testLog(`📦 Facilities to process: ${facilities.length}`);
            
            try {
                const result = await originalGeocodeAndFilterByDistance(locationTerm, facilities);
                testLog('✅ Geocoding completed successfully');
                return result;
            } catch (error) {
                testLog(`❌ Geocoding error: ${error.message}`);
                throw error;
            }
        };

        // Auto-run test after page loads
        window.addEventListener('load', () => {
            testLog('📱 Page loaded, waiting 2 seconds then running auto-test...');
            setTimeout(runTest, 2000);
        });
    </script>
</body>
</html>